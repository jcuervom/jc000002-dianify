#!/usr/bin/env bash
set -e

echo "-----> Post-compile: Starting Playwright verification"

# Check if we're on Heroku
if [ -n "$DYNO" ]; then
    echo "-----> Running on Heroku, verifying Playwright setup"
    
    # Check if PLAYWRIGHT_BROWSERS_PATH is set (by the new buildpack)
    if [ -n "$PLAYWRIGHT_BROWSERS_PATH" ]; then
        echo "-----> PLAYWRIGHT_BROWSERS_PATH found: $PLAYWRIGHT_BROWSERS_PATH"
        
        # Verify that chromium exists
        if find "$PLAYWRIGHT_BROWSERS_PATH" -name "chrome" -type f | head -1; then
            echo "-----> Chromium executable found!"
        else
            echo "-----> Warning: Chromium executable not found in browsers path"
        fi
    else
        echo "-----> Warning: PLAYWRIGHT_BROWSERS_PATH not set"
        echo "       This might indicate an issue with the Playwright buildpack"
    fi
    
    # Legacy check for old buildpack compatibility
    if [ -f "/app/.playwright-browsers-path" ]; then
        echo "-----> Legacy browsers path file found"
        BROWSERS_PATH=$(cat /app/.playwright-browsers-path)
        echo "       Legacy browsers path: $BROWSERS_PATH"
    fi
else
    echo "-----> Not running on Heroku, skipping Heroku-specific checks"
fi

# Verify Playwright installation
if command -v python3 >/dev/null 2>&1; then
    echo "-----> Verifying Playwright installation..."
    python3 -c "import playwright; print(f'Playwright version: {playwright.__version__}')" || echo "       Warning: Could not import Playwright"
else
    echo "-----> Warning: Python3 not found in PATH"
fi

echo "-----> Post-compile complete"
